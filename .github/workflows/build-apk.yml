name: Build APK

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      ANDROID_HOME: ${{ github.workspace }}/.buildozer/android/platform/android-sdk
      ANDROID_NDK_HOME: ${{ github.workspace }}/.buildozer/android/platform/android-sdk/ndk/27.3.13750724
      BUILDOZER_ANDROID_BUILD_TOOLS_VERSION: 34.0.0
      P4A_DISABLE_LIBFFI: 1

    steps:
    - name: üõéÔ∏è Checkout code
      uses: actions/checkout@v4

    - name: üî• Clean previous builds
      run: |
        rm -rf .buildozer
        rm -rf bin

    - name: üß± Install dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential ccache unzip libncurses6 openjdk-17-jdk \
          autoconf automake libtool pkg-config m4 \
          python3-pip python3-setuptools libffi-dev libssl-dev git zlib1g-dev libtinfo6
        pip3 install --upgrade pip setuptools wheel
        pip3 install buildozer cython appdirs toml build

    - name: üì¶ Install Android cmdline-tools
      run: |
        mkdir -p $ANDROID_HOME/cmdline-tools
        cd $ANDROID_HOME/cmdline-tools
        curl -O https://dl.google.com/android/repository/commandlinetools-linux-10406996_latest.zip
        unzip -q commandlinetools-linux-*.zip
        mv cmdline-tools latest

    - name: ‚úÖ Accept SDK licenses
      run: yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses

    - name: üöß Create repositories.cfg
      run: |
        mkdir -p $HOME/.android
        echo "8933bad161af4178b1185d1a37fbf41ea5269c55" > $HOME/.android/repositories.cfg

    - name: üì¶ Install platform-tools, SDK & NDK
      run: |
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager \
          "platform-tools" \
          "platforms;android-31" \
          "build-tools;34.0.0" \
          "ndk;27.3.13750724" \
          --sdk_root=$ANDROID_HOME

    - name: üö´ Block sdkmanager build-tools;36.0.0
      run: |
        mv $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager.real
        echo '#!/bin/bash' > $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager
        echo 'args="$@"' >> $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager
        echo 'if echo "$args" | grep -q "build-tools;36.0.0"; then' >> $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager
        echo '  echo "‚õî Blocked build-tools;36.0.0 manually"' >> $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager
        echo '  exit 0' >> $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager
        echo 'fi' >> $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager
        echo 'exec $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager.real "$@"' >> $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager
        chmod +x $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager

    - name: üîÄ Redirect legacy sdkmanager (tools/bin)
      run: |
        mkdir -p $ANDROID_HOME/tools/bin
        echo '#!/bin/bash' > $ANDROID_HOME/tools/bin/sdkmanager
        echo 'exec $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "$@"' >> $ANDROID_HOME/tools/bin/sdkmanager
        chmod +x $ANDROID_HOME/tools/bin/sdkmanager

    - name: üßº Remove any existing python-for-android dir
      run: rm -rf .buildozer/android/platform/python-for-android

    - name: üì• Clone your python-for-android fork
      run: |
        git clone https://github.com/ankalashton/python-for-android.git \
          .buildozer/android/platform/python-for-android

    - name: üé≠ Spoof Git origin URL
      run: |
        git config --file .buildozer/android/platform/python-for-android/.git/config \
          remote.origin.url https://github.com/kivy/python-for-android.git

    - name: üßπ Remove .git to disable repo check (optional fallback)
      run: rm -rf .buildozer/android/platform/python-for-android/.git

    - name: ‚ùå Remove libffi recipe
      run: rm -rf .buildozer/android/platform/python-for-android/pythonforandroid/recipes/libffi

    - name: üõ†Ô∏è Patch toolchain to ignore libffi
      run: |
        sed -i "/'libffi'/d" .buildozer/android/platform/python-for-android/pythonforandroid/recipe.py || true
        test -f .buildozer/android/platform/python-for-android/pythonforandroid/recipes/sqlite3/__init__.py && \
          sed -i "/'libffi'/d" .buildozer/android/platform/python-for-android/pythonforandroid/recipes/sqlite3/__init__.py || true

    - name: üèóÔ∏è Build APK
      run: |
        buildozer android clean
        buildozer android debug

    - name: üì¶ Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: androidrdp_apk
        path: bin/*.apk
